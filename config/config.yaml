# Project identity
parent: blueleaflabs
project: hydropulse

run_tag: "v1.0"

# California bounding box (approximate)
bbox:
  nwlat: 42.0095
  nwlng: -124.4820
  selat: 32.5343
  selng: -114.1315
region: "CA"


# Time window (UTC)
start_date: "2024-06-01"
end_date: "2024-10-31"

# Baseline period for anomalies
BASELINE_START_DATE: "1991-01-01"
BASELINE_END_DATE: "2025-12-31"

# Used for aggregations and summaries
HYDRO_VARIABLES:
  precipitation:
    units: "mm"
    aggregation: "sum"
  temperature:
    units: "C"
    aggregation: "mean"

# Used to distinguish transient events vs persistent regimes
TEMPORAL_WINDOWS_DAYS:
  - 1
  - 7
  - 30
  - 90


# Optional local overrides

# Base URLs
USCRN_BASE_HOURLY: "https://www.ncei.noaa.gov/pub/data/uscrn/products/hourly02/"
GHCND_STATIONS_URL: "https://www.ncei.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt"
CENSUS_STATES_ZIP_URL: "https://www2.census.gov/geo/tiger/GENZ2023/shp/cb_2023_us_state_20m.zip"
CDO_BASE_URL: "https://www.ncei.noaa.gov/cdo-web/api/v2/data"
PRISM_SERVICE_BASE_URL:  "https://services.nacse.org/prism/data/get"


# Headers
USER_AGENT_HEADERS:
  User-Agent: "BlueLeafLabs/HydroPulse/1.0"

# Output paths (relative to repo root)
out_dir: "results"

# Spatial config
WGS84_EPSG: 4326
CA_ALBERS_EPSG: 3310
OPS_EPSG: 3310
grid_resolution_m: 3000
crs_epsg: 4326

# USCRN configuration for California
USCRN_STATION_NAME:
  - "CA Bodega 6 WSW"
  - "CA Fallbrook 5 NE"
  - "CA Merced 23 WSW"
  - "CA Redding 12 WNW"
  - "CA Santa Barbara 11 W"
  - "CA Stovepipe Wells 1 SW"
  - "CA Yosemite Village 12 W"
USCRN_YEARS:
  - 2024


# Data directories (relative to out_dir)
CDO_RAW_DIRNAME: "cdo_raw_monthly"
CDO_CLEAN_DIRNAME: "cdo_clean"
USCRN_RAW_DIRNAME: "uscrn_raw"
USCRN_CLEAN_DIRNAME: "uscrn_clean"
MANUAL_DIRNAME: "manual"
LOOKUPS_DIRNAME: "lookups"
PRISM_RAW_DIRNAME: "prism_raw"
PRISM_CLEAN_DIRNAME: "prism_clean"
ERA5_RAW_DIRNAME: "era5_raw"
ERA5_CLEAN_DIRNAME: "era5_clean"
SMAP_RAW_DIRNAME: "smap_raw"
SMAP_CLEAN_DIRNAME: "smap_clean"
SNOTEL_RAW_DIRNAME: "snotel_raw"
SNOTEL_CLEAN_DIRNAME: "snotel_clean"

# SMAP Soil Moisture parameters
SMAP_L4_SHORT_NAME: "SPL4SMGP"
SMAP_L4_VARIABLES: ["sm_surface", "sm_rootzone"]


# GHCND outputs (relative to out_dir)
GHCND_RAW_CSV_NAME: "ghcnd_daily_raw_all.csv"
GHCND_CLEAN_PARQUET_NAME: "ghcnd_daily_cleaned.parquet"
GHCND_CLEAN_CSV_NAME: "ghcnd_daily_cleaned.csv"
GHCND_STATIONS_TXT_NAME: "ghcnd-stations.txt"


# GHCND outputs (relative to out_dir)
GHCND_RAW_CSV_NAME: "ghcnd_daily_raw_all.csv"
GHCND_CLEAN_PARQUET_NAME: "ghcnd_daily_cleaned.parquet"
GHCND_CLEAN_CSV_NAME: "ghcnd_daily_cleaned.csv"
GHCND_STATIONS_TXT_NAME: "ghcnd-stations.txt"


# Analysis outputs (relative to out_dir)
GRID_FILENAME: "grid_3000m_CA_epsg3310.parquet"
USCRN_FILENAME: "uscrn_2024_hourly_clean.parquet"
GHCND_FILENAME: "ghcnd_daily_cleaned.parquet"
FINAL_DAILY_FILENAME: "final_daily_grid_3000m_20240601_20241031.parquet"
FINAL_DAILY_FILENAME_TEMPLATE: "final_daily_grid_{region}_{res_m}m_epsg{epsg}_{start}_{end}.parquet"
MANUAL_DIRNAME: "manual"
PRISM_MANUAL_DIR: "results/manual/prism"

# SNOTEL
SNOTEL_MANUAL_DIR: "manual/snotel"
SNOTEL_RAW_FILENAME: "snotel-19910101-20260112.txt"
# Output parquet (stored directly under out_dir/results)
SNOTEL_DAILY_LONG_PARQUET_NAME: "snotel_daily_long.parquet"

SNOTEL_GRIDMAP_PARQUET_NAME: "snotel_station_to_grid_3310.parquet"
SNOTEL_DAILY_GRID_PARQUET_NAME: "snotel_daily_grid_CA_3000m_epsg3310_{start}_{end}.parquet"
SNOTEL_GRID_SHARDS_DIRNAME: "derived/snotel_grid_shards"

SNOTEL_STATION_META_PARQUET_NAME: "snotel_station_metadata.parquet"
AWDB_META_URL_TEMPLATE: "https://wcc.sc.egov.usda.gov/awdbRestApi/services/v1/stations?stationTriplets={triplets}&elements="
# triplets will look like: 1234:CA:SNTL

# ERA5 / ERA5-Land
ERA5_DAILY_DATASET: "derived-era5-land-daily-statistics"
ERA5_MONTHLY_DATASET: "reanalysis-era5-land-monthly-means"

ERA5_VARIABLES_DAILY:
  - "2m_temperature"
  - "snow_depth_water_equivalent"
  - "volumetric_soil_water_layer_1"
# Download controls 
ERA5_MAX_RETRIES: 6
ERA5_BACKOFF_BASE_S: 25

# PRISM variables
PRISM_REGION: "us"
PRISM_RESOLUTION: "4km"
PRISM_ELEMENTS: ["ppt", "tmean"]

# “Small chunks” controls
PRISM_RUN_YEAR_START: 1991
PRISM_RUN_YEAR_END: 1991
PRISM_MAX_DOWNLOADS_PER_RUN: 365

# Server politeness
PRISM_BASE_SLEEP_S: 2.5
PRISM_JITTER_S: 0.75
PRISM_TIMEOUT_S: 120
PRISM_MAX_RETRIES: 6
PRISM_BACKOFF_BASE: 1.7


# GHCND/USCRN processing parameters
USCRN_YEARS_FILTER: [2024]


# SMAP L4 group/vars (confirmed from your file)
SMAP_L4_SHORT_NAME: "SPL4SMGP"
SMAP_L4_DIRNAME: "manual/smap/SPL4SMGP"
SMAP_NETCDF_GROUP: "Geophysical_Data"

SMAP_VAR_SURFACE: "sm_surface"
SMAP_VAR_ROOTZONE: "sm_rootzone"

# Outputs
SMAP_DAILY_DIRNAME: "derived/smap_daily"
SMAP_DAILY_TEMPLATE: "smap_daily_{date}.parquet"   # YYYY-MM-DD
SMAP_DAILY_AGG: "median"                           # median recommended
SMAP_LOG_EVERY_N_DAYS: 20

# SMAP -> HydroPulse grid mapping
SMAP_L4_DIRNAME: "manual/smap/SPL4SMGP"           # already have
SMAP_NETCDF_GROUP: "Geophysical_Data"             # already have (Cell A)
SMAP_DAILY_DIRNAME: "derived/smap_daily"          # already have

SMAP_GRIDMAP_FILENAME: "smap_pixel_to_grid_3310.parquet"

SMAP_GRID_DAILY_SHARDS_DIRNAME: "derived/smap_grid_shards"
SMAP_GRID_FINAL_FILENAME: "smap_daily_grid_CA_3000m_epsg3310_{start}_{end}.parquet"

# Aggregation controls
SMAP_GRID_AGG: "mean"               # mean is standard
SMAP_GRID_MIN_PIXELS: 1             # require at least this many SMAP pixels in a grid cell per day
SMAP_LOG_EVERY_N_DAYS: 20           # reuse your existing pattern
SMAP_NEAREST_FALLBACK_KM: 6.0       # fallback radius if some pixels miss polygons


# USGS Streamflow parameters
# From: https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=CA&siteType=ST&hasDataTypeCd=dv
USGS_RAW_DIRNAME: "usgs_raw"
USGS_CLEAN_DIRNAME: "usgs_clean"

USGS_PARAM_DISCHARGE: "00060"
USGS_SITE_TYPE: "ST"
USGS_STATE_CD: "CA"
USGS_START_DATE: "1991-01-01"
USGS_END_DATE: "2025-12-31"

USGS_SLEEP_S: 2.5
USGS_MAX_RETRIES: 6
USGS_BACKOFF_BASE_S: 10
USGS_TIMEOUT_S: 180
USGS_DV_DAILY_PARQUET_NAME: "usgs_dv_daily_long.parquet"

# MODIS NDVI
# MODIS / AppEEARS (MOD13Q1)
MODIS_ANALYSIS_DIR: "manual/modis_ndvi_analysis"
MODIS_BASELINE_DIR: "manual/modis_ndvi_baseline"

MODIS_PRODUCT: "MOD13Q1"
MODIS_VERSION: "061"
MODIS_FEATURE_ID: "aid0002"              # change if your files use a different aid####
MODIS_SCALE_FACTOR: 0.0001              # NDVI/EVI scale
MODIS_ACCEPT_VI_QUALITY: [0]            # keep only VI_Quality==0 by default (conservative)

MODIS_SHARDS_DIR: "derived/modis_grid_shards"
MODIS_OUT_PARQUET_TEMPLATE: "modis_vi_grid_CA_{res_m}m_epsg{epsg}_{tag}.parquet"

MODIS_ENFORCE_QA: false
# if AppEEARS export includes a SummaryQA layer, this controls which SummaryQA integer codes are accepted when MODIS_ENFORCE_QA: true
MODIS_ACCEPT_SUMMARY_QA: [0]

# extra “nodata/fill” sentinels to mask when the GeoTIFF’s nodata is missing or unreliable (common in some exports)
MODIS_COMMON_FILL_VALUES: [-3000, -28672, -9999, 32767, 65535]
MODIS_ACCEPT_VI_QUALITY: []            # keep all quality by default


MODIS_CELL_A_SHARDS_DIRNAME_BASELINE: "modis_cellA_shards_baseline"
MODIS_CELL_A_SHARDS_DIRNAME_ANALYSIS: "modis_cellA_shards_analysis"
MODIS_GRID_SHARDS_DIRNAME_BASELINE: "modis_grid_shards_baseline"
MODIS_GRID_SHARDS_DIRNAME_ANALYSIS: "modis_grid_shards_analysis"
MODIS_GRID_BASELINE_PARQUET_NAME: "modis_vi_grid_baseline_CA_3000m_epsg3310.parquet"
MODIS_GRID_ANALYSIS_PARQUET_NAME: "modis_vi_grid_analysis_CA_3000m_epsg3310_20240601_20241031.parquet"


# --- ERA5 Cell A outputs ---
ERA5_CELL_A_DAILY_SHARDS_DIRNAME: "era5_cellA_shards_daily"
ERA5_CELL_A_MONTHLY_SHARDS_DIRNAME: "era5_cellA_shards_monthly"

ERA5_DAILY_LONG_PARQUET_NAME: "era5_daily_long_analysis.parquet"
ERA5_MONTHLY_LONG_PARQUET_NAME: "era5_monthly_long_baseline.parquet"

# Assembly behavior (daily analysis assembled; monthly baseline shards-only by default)
ERA5_ASSEMBLE_DAILY_ANALYSIS: true
ERA5_ASSEMBLE_MONTHLY_BASELINE: false



# HTTP timeouts and retries (seconds unless noted)
USCRN_LIST_TIMEOUT: 120
USCRN_DOWNLOAD_TIMEOUT: 300
GHCND_TIMEOUT: 120
CENSUS_STATES_TIMEOUT: 120


# NLCD/HMS/other timeouts
DOWNLOAD_TIMEOUT: 60


# Data source naming reference (human-readable)
DATA_SOURCES:
  USCRN:
    raw_parquet: "uscrn_2024_hourly_raw.parquet"
    clean_parquet: "uscrn_2024_hourly_clean.parquet"
  GRID:
    wgs84_parquet: "grid_{res_m}m_CA.parquet"
    epsg3310_parquet: "grid_{res_m}m_CA_epsg3310.parquet"
